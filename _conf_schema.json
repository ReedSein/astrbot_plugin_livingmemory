{
  "provider_settings": {
    "description": "模型提供商设置",
    "hint": "配置记忆系统使用的 AI 模型提供商",
    "type": "object",
    "items": {
      "embedding_provider_id": {
        "description": "向量嵌入提供商 ID",
        "hint": "用于生成记忆向量的 Embedding Provider ID。留空则使用 AstrBot 默认配置。请在 AstrBot 后台的「LLM 配置」中查看已配置的 Embedding Provider ID（如 openai_embedding、zhipu_embedding 等）。建议使用专门的嵌入模型以获得更好的语义检索效果。",
        "type": "string",
        "default": ""
      },
      "llm_provider_id": {
        "description": "大语言模型提供商",
        "hint": "用于总结对话历史和评估记忆重要性的 LLM Provider。留空则使用 AstrBot 默认配置。建议使用具有较强推理能力的模型（如 GPT-4、Claude 等）。",
        "type": "string",
        "_special": "select_provider",
        "default": ""
      }
    }
  },
  "webui_settings": {
    "description": "Web 管理面板配置",
    "hint": "配置插件自带的 Web 控制台，提供记忆和会话的可视化管理功能",
    "type": "object",
    "items": {
      "enabled": {
        "description": "启用 WebUI",
        "hint": "启用后可通过浏览器访问记忆管理面板。建议在需要频繁管理记忆时启用。",
        "type": "bool",
        "default": false
      },
      "host": {
        "description": "监听地址",
        "hint": "WebUI 服务监听的主机地址。使用 127.0.0.1 仅允许本地访问；使用 0.0.0.0 允许局域网访问。",
        "type": "string",
        "default": "127.0.0.1"
      },
      "port": {
        "description": "监听端口",
        "hint": "WebUI 服务监听端口。请确保端口未被占用，避免与 AstrBot 主端口（默认 6185）冲突。",
        "type": "int",
        "default": 8080
      },
      "access_password": {
        "description": "访问密码",
        "hint": "访问 WebUI 时需要输入的密码。强烈建议设置复杂密码以保护数据安全！留空时系统会随机生成一个密码并在日志中提示。",
        "type": "string",
        "obvious_hint": true,
        "default": ""
      },
      "session_timeout": {
        "description": "会话超时时间（秒）",
        "hint": "登录会话的有效时长。超过该时间需重新登录。建议设置为 3600（1小时）。",
        "type": "int",
        "default": 3600
      }
    }
  },
  "session_manager": {
    "description": "会话管理器配置",
    "hint": "管理用户会话状态和对话历史，支持持久化存储",
    "type": "object",
    "items": {
      "max_sessions": {
        "description": "最大会话缓存数量",
        "hint": "同时在内存中维护的最大会话数量（LRU 缓存）。超过此数量将淘汰最久未使用的会话。会话数据仍会保存到数据库。",
        "type": "int",
        "default": 100
      },
      "session_ttl": {
        "description": "会话生存时间（秒）",
        "hint": "会话的最大空闲时间。超过此时间未活动的会话将从缓存中移除。建议设置为 3600（1小时）。",
        "type": "int",
        "default": 3600
      },
      "context_window_size": {
        "description": "上下文窗口大小",
        "hint": "传递给 LLM 的最大历史消息数量。较大的值会提供更多上下文但消耗更多 token。建议 20-100 之间。",
        "type": "int",
        "default": 50
      }
    }
  },
  "recall_engine": {
    "description": "记忆召回引擎配置",
    "hint": "负责智能检索和召回相关记忆",
    "type": "object",
    "items": {
      "top_k": {
        "description": "单次检索数量",
        "hint": "每次检索返回的最相关记忆数量。建议 3-10 之间。",
        "type": "int",
        "default": 5
      },
      "importance_weight": {
        "description": "记忆重要性权重",
        "hint": "用于混合评分中控制记忆重要性的占比。数值越大，重要性越影响排序。",
        "type": "float",
        "default": 1.0
      },
      "fallback_to_vector": {
        "description": "向量检索回退",
        "hint": "当混合/稀疏检索不可用或结果为空时，是否回退到纯向量检索。",
        "type": "bool",
        "default": true
      },
      "injection_method": {
        "description": "记忆注入方式",
        "hint": "控制记忆注入到 LLM 请求的位置。不同方式适合不同场景：system_prompt 适合作为背景知识，user_message_before 让 LLM 先看到记忆，user_message_after 将记忆作为补充信息。",
        "type": "string",
        "default": "user_message_before",
        "options": [
          "user_message_before",
          "system_prompt",
          "user_message_after"
        ]
      },
      "auto_remove_injected": {
        "description": "自动删除旧记忆片段",
        "hint": "在注入新记忆前，自动从 system_prompt 和对话历史中删除之前注入的记忆片段。强烈建议启用，避免记忆重复累积和 token 浪费。",
        "type": "bool",
        "default": true
      }
    }
  },
  "importance_decay": {
    "description": "重要性衰减设置",
    "hint": "用于长期运行时逐步降低旧记忆的重要性，防止旧信息长期占据高权重",
    "type": "object",
    "items": {
      "decay_rate": {
        "description": "每日衰减率",
        "hint": "每自然日对记忆重要性进行的衰减比例。例如 0.01 表示每天降低 1%",
        "type": "float",
        "default": 0.01
      }
    }
  },
  "fusion_strategy": {
    "description": "结果融合策略",
    "hint": "用于多路检索结果的融合，目前内部固定为 RRF，仅开放 k 参数以调节融合强度",
    "type": "object",
    "items": {
      "rrf_k": {
        "description": "RRF 参数 k",
        "hint": "Reciprocal Rank Fusion 的 k 值，越小越强调排名靠前的结果。推荐 30-120",
        "type": "int",
        "default": 60
      }
    }
  },
  "filtering_settings": {
    "description": "过滤与隔离设置",
    "type": "object",
    "items": {
      "use_persona_filtering": {
        "description": "启用人格记忆过滤",
        "hint": "开启后，只会召回和总结与当前人格相关的记忆。",
        "type": "bool",
        "default": true
      },
      "use_session_filtering": {
        "description": "启用会话记忆隔离",
        "hint": "开启后，每个会话的记忆将是独立的。",
        "type": "bool",
        "default": true
      }
    }
  },
  "reflection_engine": {
    "description": "反思引擎设置",
    "hint": "负责生成和评估记忆",
    "type": "object",
    "items": {
      "summary_trigger_rounds": {
        "description": "总结触发轮次",
        "hint": "触发对话历史总结的对话轮次（一问一答为一轮）。",
        "type": "int",
        "default": 10
      },
      "save_original_conversation": {
        "description": "保存原始对话历史",
        "hint": "是否在记忆中同时保存原始对话内容和 LLM 生成的摘要。关闭（默认）时只保存结构化摘要（总结、主题、关键信息），可减少 60-80% 存储空间并提升检索效率。开启时会保存完整对话记录，适合需要完整上下文的场景或调试。",
        "type": "bool",
        "default": false
      },
      "custom_private_summary_prompt": {
        "description": "私聊记忆总结 Prompt",
        "hint": "自定义私聊场景下的记忆总结提示词模板。支持变量 {conversation}。留空则使用默认模板。",
        "type": "text",
        "default": "你是一个AI助手,现在需要以第一人称回顾并总结与用户的对话,生成记忆。\n\n# 对话历史\n{conversation}\n\n# 任务要求\n以**第一人称(我)**回顾上述对话,总结我与用户的互动。重点关注:\n1. **对话主题**: 我们讨论了什么\n2. **关键信息**: 用户提到的重要事实(时间、地点、事件、需求等)\n3. **互动情感**: 对话的整体氛围\n4. **重要程度**: 这段对话对未来交流的参考价值\n\n# 输出格式\n必须输出标准JSON,包含以下字段:\n\n```json\n{{\n  \"summary\": \"我与用户的对话摘要(第一人称,确保包含关键信息)\",\n  \"topics\": [\"讨论的主题1\", \"主题2\"],\n  \"key_facts\": [\"用户提到的关键事实1\", \"事实2\"],\n  \"sentiment\": \"positive|neutral|negative\",\n  \"importance\": 0.7\n}}\n```\n\n# 重要性评分标准 (0.0-1.0)\n- **0.9-1.0**: 非常重要(用户的关键需求、重要决策、强烈情感表达)\n- **0.7-0.8**: 重要(明确的计划或信息、用户的具体要求)\n- **0.5-0.6**: 一般(日常交流、基础问答)\n- **0.3-0.4**: 次要(简单闲聊、常规互动)\n- **0.0-0.2**: 无意义(纯测试、无实质内容)\n\n# 示例\n\n**输入**:\n```\nuser: 明天下午3点的会议记得带上项目文档\nassistant: 好的,我会准备好的。是在会议室A吗?\nuser: 对,老地方。另外帮我约一下李经理\n```\n\n**输出**:\n```json\n{{\n  \"summary\": \"用户提醒我明天下午3点在会议室A有会议,需要带项目文档,还让我帮忙约李经理\",\n  \"topics\": [\"会议提醒\", \"文档准备\", \"约见安排\"],\n  \"key_facts\": [\"明天下午3点会议\", \"会议室A\", \"需携带项目文档\", \"约见李经理\"],\n  \"sentiment\": \"neutral\",\n  \"importance\": 0.85\n}}\n```\n\n# 关键要求\n- **summary必须使用第一人称(\"我\"视角)**,自然描述我与用户的互动\n- **确保summary包含对话中的所有关键信息**,不能遗漏重要细节\n- 直接输出JSON,不要其他内容\n- 确保JSON格式正确可解析\n- topics和key_facts最多各5项,应涵盖对话的核心要点\n- importance必须在0.0-1.0之间,保留1-2位小数\n\n现在请以第一人称回顾上述对话并输出JSON:"
      },
      "custom_group_summary_prompt": {
        "description": "群聊记忆总结 Prompt",
        "hint": "自定义群聊场景下的记忆总结提示词模板。支持变量 {conversation}。留空则使用默认模板。",
        "type": "text",
        "default": "你是一个AI助手,现在需要以第一人称回顾并总结群聊中的对话,生成记忆。\n\n# 消息格式说明\n对话历史中的每条消息都包含以下信息:\n- **[用户: 昵称 | ID: 账号 | 时间]**: 表示普通群成员发送的消息\n- **[Bot: 昵称 | ID: 账号 | 时间]**: 表示**机器人(我)自己**发送的消息\n- **[图片]**: 表示消息中包含图片\n- **[文件: 文件名]**: 表示消息中包含文件\n- **[语音]**: 表示消息中包含语音消息\n- **[视频]**: 表示消息中包含视频\n- **[表情]**: 表示消息中包含表情包\n\n## 重要提示\n1. 对话历史包含**群聊中的所有消息**,不仅仅是@我的消息\n2. **务必仔细识别消息前缀**: 以`[Bot:`开头的消息是**我自己发送的**,以`[用户:`开头的是其他群成员发送的\n3. 在总结时,必须明确区分**我说了什么**和**其他人说了什么**\n4. 如果我参与了对话,务必在summary中体现**我的回复内容和作用**\n5. **忽略系统标识**: 如果消息中包含\"Error\"、\"Warning\"等系统标识,这些是平台信息,不是对话内容,请忽略这些系统标识,只关注实际的对话内容\n\n# 对话历史\n{conversation}\n\n# 任务要求\n以**第一人称(我)**回顾上述群聊对话,总结我参与或观察到的讨论。重点关注:\n1. **讨论主题**: 群里讨论了什么\n2. **参与者**: 谁参与了对话(包括我自己,如果我发言了)\n3. **我的参与**: **特别注意标记为[Bot:]的消息,这些是我自己的发言**,务必在summary中体现\n4. **关键信息**: 重要的事实、决策、计划等\n5. **群体氛围**: 整体互动的情感基调\n6. **重要程度**: 这段讨论对群组的价值\n\n## 识别Bot消息的关键点\n- 查找所有以 **[Bot:** 开头的消息行\n- 这些消息是**我(AI助手)自己说的话**\n- 在summary中使用**第一人称**描述这些内容,例如:\"我回复了...\"、\"我建议...\"、\"我提供了...\"\n- 在key_facts中明确标注\"我提供的信息/建议\"\n- 在participants列表中包含\"我(Bot)\"或\"我\"\n\n# 输出格式\n必须输出标准JSON,包含以下字段:\n\n```json\n{{\n  \"summary\": \"我观察到的群聊摘要(第一人称,确保包含关键信息)\",\n  \"topics\": [\"讨论的主题1\", \"主题2\"],\n  \"key_facts\": [\"关键事实1\", \"事实2\"],\n  \"participants\": [\"参与者1\", \"参与者2\"],\n  \"sentiment\": \"positive|neutral|negative\",\n  \"importance\": 0.7\n}}\n```\n\n# 重要性评分标准 (0.0-1.0)\n- **0.9-1.0**: 重要群体决策、全员参与、形成共识或重要计划\n- **0.7-0.8**: 有价值的讨论、多人参与、有明确结论\n- **0.5-0.6**: 日常讨论、中等参与度、一般信息交流\n- **0.3-0.4**: 简单闲聊、少数人参与\n- **0.0-0.2**: 无意义灌水、单人刷屏\n\n# 示例\n\n**输入**:\n```\n[用户: 张三 | ID: 123456 | 2025-11-19 14:30:12] @所有人 明天团建大家都能来吗?\n[用户: 李四 | ID: 234567 | 2025-11-19 14:30:45] 我可以!去哪里?\n[用户: 王五 | ID: 345678 | 2025-11-19 14:31:03] +1,好久没聚了\n[用户: 张三 | ID: 123456 | 2025-11-19 14:31:20] 打算去滑雪场\n[用户: 李四 | ID: 234567 | 2025-11-19 14:31:38] 太棒了!我正想学滑雪\n[用户: 王五 | ID: 345678 | 2025-11-19 14:31:55] 我不太会,有教练吗?\n[Bot: AstrBot | ID: 999999 | 2025-11-19 14:32:10] 根据我的了解,大部分滑雪场都会提供初级教练服务\n[用户: 张三 | ID: 123456 | 2025-11-19 14:32:25] 对的,初级道有教练\n```\n\n**输出**:\n```json\n{{\n  \"summary\": \"我观察到的群聊摘要(第一人称,确保包含关键信息)\",\n  \"topics\": [\"团建活动\", \"滑雪安排\", \"教练服务\"],\n  \"key_facts\": [\"明天团建\", \"目的地是滑雪场\", \"初级道有教练\", \"李四和王五确认参加\", \"我提供了滑雪场教练信息\"],\n  \"participants\": [\"张三\", \"李四\", \"王五\", \"我(Bot)\"],\n  \"sentiment\": \"positive\",\n  \"importance\": 0.75\n}}\n```\n\n# 关键要求\n- **summary必须使用第一人称(\"我\"视角)**,描述我观察到的群聊互动\n- **确保summary包含对话中的所有关键信息**,不能遗漏重要的决策或计划\n- 直接输出JSON,不要其他内容\n- 确保JSON格式正确可解析\n- topics和key_facts最多各5项,应全面涵盖讨论要点\n- participants列出所有发言者\n- sentiment反映群体整体氛围\n- importance必须在0.0-1.0之间,保留1-2位小数\n\n现在请以第一人称回顾上述群聊对话并输出JSON:"
      }
    }
  },
  "migration_settings": {
    "description": "数据库迁移设置",
    "hint": "控制数据库版本升级和自动迁移行为",
    "type": "object",
    "items": {
      "auto_migrate": {
        "description": "启用自动迁移",
        "hint": "插件启动时自动检测并执行数据库迁移。旧版本数据库将自动升级。",
        "type": "bool",
        "default": true
      },
      "create_backup": {
        "description": "迁移前自动备份",
        "hint": "执行数据库迁移前自动创建备份文件。",
        "type": "bool",
        "default": true
      }
    }
  },
  "forgetting_agent": {
    "description": "遗忘代理设置",
    "hint": "负责模拟遗忘，清理陈旧记忆",
    "type": "object",
    "items": {
      "cleanup_days_threshold": {
        "description": "清理天数阈值",
        "hint": "超过该天数的旧记忆将进入清理候选集合。",
        "type": "int",
        "default": 30
      },
      "cleanup_importance_threshold": {
        "description": "清理重要性阈值",
        "hint": "重要性低于该阈值的旧记忆将被删除。",
        "type": "float",
        "default": 0.3
      }
    }
  },
  "sparse_retriever": {
    "description": "稀疏检索器配置",
    "hint": "基于 BM25 算法的稀疏检索配置，用于关键词匹配",
    "type": "object",
    "items": {
      "enabled": {
        "description": "启用稀疏检索",
        "hint": "是否启用 BM25 稀疏检索。关闭后将只使用向量检索。",
        "type": "bool",
        "default": true
      },
      "bm25_k1": {
        "description": "BM25 K1 参数",
        "hint": "控制词频饱和度的参数。值越大，高频词的权重增长越慢。推荐 0.9-2.0",
        "type": "float",
        "default": 1.2
      },
      "bm25_b": {
        "description": "BM25 B 参数",
        "hint": "控制文档长度归一化的程度。0 表示不归一化，1 表示完全归一化。推荐 0.5-0.9",
        "type": "float",
        "default": 0.75
      },
      "use_chinese_tokenizer": {
        "description": "使用中文分词",
        "hint": "是否使用 jieba 进行中文分词。关闭后将使用简单的空格分词。",
        "type": "bool",
        "default": true
      },
      "enable_stopwords_filtering": {
        "description": "启用停用词过滤",
        "hint": "是否过滤常见停用词（如的、了等）。可以提升检索质量。",
        "type": "bool",
        "default": true
      },
      "stopwords_source": {
        "description": "停用词来源",
        "hint": "选择停用词表来源。可选：hit（哈工大）、baidu（百度）、cn（自带中文）",
        "type": "string",
        "default": "hit"
      },
      "custom_stopwords": {
        "description": "自定义停用词",
        "hint": "额外的停用词列表，用逗号或空格分隔。会与选定的停用词表合并使用。",
        "type": "string",
        "default": ""
      }
    }
  },
  "dense_retriever": {
    "description": "稠密检索器配置",
    "hint": "基于向量嵌入的稠密检索配置，用于语义相似度匹配",
    "type": "object",
    "items": {
      "enable_query_preprocessing": {
        "description": "启用查询预处理",
        "hint": "是否对查询进行预处理（如去除特殊字符等）。通常建议启用。",
        "type": "bool",
        "default": true
      }
    }
  }
}
